#!/usr/bin/env bash
set -euo pipefail

ROOT="/etc/nixos"
HOST="$(hostname)"
SESSION_FILE="$ROOT/docs/SESJA.md"

RED="\033[31m"
YELLOW="\033[33m"
GREEN="\033[32m"
RESET="\033[0m"

fail() {
  echo -e "${RED}‚ùå $1${RESET}"
  exit 1
}

warn() {
  echo -e "${YELLOW}‚ö†Ô∏è  $1${RESET}"
}

ok() {
  echo -e "${GREEN}‚úÖ $1${RESET}"
}

header() {
  echo
  echo "=============================="
  echo "üõ°  NSS SAFETY CHECK"
  echo "=============================="
  echo
}
header

cd "$ROOT"

# 1. repo clean (tracked + untracked)
if [[ -n "$(git status --porcelain)" ]]; then
  fail "Repo /etc/nixos jest brudne (tracked lub untracked)"
fi
ok "Repo clean"

# 2. flake check
echo "üîç nix flake check‚Ä¶"
nix flake check "$ROOT" || fail "flake check failed"
ok "Flake OK"

CRITICAL_PATHS=(
  "nixos/configuration.nix"
  "flake.nix"
  "modules/boot.nix"
  "modules/graphics.nix"
)

CRITICAL_HIT=0

for path in "${CRITICAL_PATHS[@]}"; do
  if git diff --name-only | grep -q "^$path"; then
    CRITICAL_HIT=1
  fi
done

if [[ "$CRITICAL_HIT" -eq 1 ]]; then
  warn "Zmiany dotykajƒÖ KRYTYCZNYCH PLIK√ìW"
  RISK="HIGH"
else
  RISK="NORMAL"
fi

echo
echo "üß† Decision gate"
echo "Ryzyko: $RISK"
echo
echo "Zmodyfikowane pliki:"
git diff --name-only
echo

echo "[A] build only"
echo "[B] build + switch"
echo "[C] build + switch + commit"
echo "[D] abort (domy≈õlne)"
echo

read -r -p "Wyb√≥r: " CHOICE
CHOICE="${CHOICE:-D}"

case "$CHOICE" in
A | a) MODE="build" ;;
B | b) MODE="switch" ;;
C | c) MODE="commit" ;;
*)
  fail "Abort by user"
  ;;
esac

ok "Wybrany tryb: $MODE"

echo
echo "üèó  BUILD: nix build (system)"
nix build "$ROOT#nixosConfigurations.$HOST.config.system.build.toplevel" ||
  fail "Build failed"

ok "Build OK"

if [[ "$MODE" == "switch" || "$MODE" == "commit" ]]; then
  echo
  echo "üîÅ SWITCH: nixos-rebuild switch"
  sudo nixos-rebuild switch --flake "$ROOT#$HOST" ||
    fail "Switch failed"

  ok "Switch OK"
fi

read -r -p "Kontynuowaƒá? (wpisz 'zamykamy' aby przerwaƒá): " LAST
if [[ "$LAST" == "zamykamy" ]]; then
  fail "Przerwano has≈Çem awaryjnym"
fi

ok "Bezpiecznik przeszed≈Ç"
