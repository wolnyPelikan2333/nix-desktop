#!/usr/bin/env bash
set -euo pipefail

# =============================
# NSS SAFE â€” FINAL VERSION
# =============================

ROOT="/etc/nixos"
HOST="$(hostname)"
SESSION_FILE="$ROOT/docs/SESJA.md"

# ---------- FLAGS ----------
DRY=0
FORCE=0
PANIC=0

for arg in "$@"; do
  case "$arg" in
  --dry) DRY=1 ;;
  --force) FORCE=1 ;;
  --panic) PANIC=1 ;;
  esac
done

# ---------- COLORS ----------
RED="\033[31m"
YELLOW="\033[33m"
GREEN="\033[32m"
RESET="\033[0m"

fail() {
  echo -e "${RED}âŒ $1${RESET}"
  exit 1
}
warn() { echo -e "${YELLOW}âš ï¸  $1${RESET}"; }
ok() { echo -e "${GREEN}âœ… $1${RESET}"; }

header() {
  echo
  echo "=============================="
  echo "ðŸ›¡  NSS SAFETY CHECK"
  echo "=============================="
  echo
}

# ---------- HEADER ----------
header

# ---------- PANIC ----------
if [[ "$PANIC" -eq 1 ]]; then
  echo "ðŸ§¯ PANIC MODE: rollback"
  sudo nixos-rebuild switch --rollback || fail "Rollback failed"
  ok "Rollback OK"
  exit 0
fi

[[ "$DRY" -eq 1 ]] && warn "DRY RUN: brak zmian w systemie"

cd "$ROOT"

# ---------- PREFLIGHT ----------
if [[ -n "$(git status --porcelain)" ]]; then
  if [[ "$FORCE" -eq 1 ]]; then
    warn "FORCE: repo brudne, kontynuujÄ™"
  else
    fail "Repo /etc/nixos jest brudne (tracked lub untracked)"
  fi
fi
ok "Repo clean"

echo "ðŸ” nix flake checkâ€¦"
nix flake check "$ROOT" || fail "flake check failed"
ok "Flake OK"

# ---------- RISK ----------
CRITICAL_PATHS=(
  "nixos/configuration.nix"
  "flake.nix"
  "modules/boot.nix"
  "modules/graphics.nix"
)

RISK="NORMAL"
for path in "${CRITICAL_PATHS[@]}"; do
  if git diff --name-only | grep -q "^$path"; then
    RISK="HIGH"
  fi
done

# ---------- GATE ----------
echo
echo "ðŸ§  Decision gate"
echo "Ryzyko: $RISK"
echo
echo "Zmodyfikowane pliki:"
git diff --name-only || true
echo
echo "[A] build only"
echo "[B] build + switch"
echo "[C] build + switch + commit"
echo "[D] abort (domyÅ›lne)"
echo

read -r -p "WybÃ³r: " CHOICE
CHOICE="${CHOICE:-D}"

case "$CHOICE" in
A | a) MODE="build" ;;
B | b) MODE="switch" ;;
C | c) MODE="commit" ;;
*) fail "Abort by user" ;;
esac

ok "Wybrany tryb: $MODE"

# ---------- BUILD ----------
echo
echo "ðŸ—  BUILD: nix build (system)"
if [[ "$DRY" -eq 1 ]]; then
  warn "DRY: pomijam build"
else
  nix build "$ROOT#nixosConfigurations.$HOST.config.system.build.toplevel" ||
    fail "Build failed"
  ok "Build OK"
fi

# ---------- SWITCH ----------
if [[ "$MODE" == "switch" || "$MODE" == "commit" ]]; then
  echo
  echo "ðŸ” SWITCH: nixos-rebuild switch"
  if [[ "$DRY" -eq 1 ]]; then
    warn "DRY: pomijam switch"
  else
    sudo nixos-rebuild switch --flake "$ROOT#$HOST" ||
      fail "Switch failed"
    ok "Switch OK"
  fi
fi

# ---------- POST-SUCCESS ----------
if [[ "$MODE" == "commit" && "$DRY" -eq 0 ]]; then
  CHANGES="$(git status --porcelain)"

  if [[ -z "$CHANGES" ]]; then
    warn "Brak zmian do commit â€” pomijam auto-commit"
  else
    echo
    echo "ðŸ“ AUTO-COMMIT"

    git add -A
    git commit -m "nss: apply nixos config

Risk: $RISK
Touched:
$(git diff --name-only HEAD)
" || fail "Commit failed"

    ok "Commit OK"

    echo
    echo "ðŸ““ SESJA.md"
    DATE="$(date '+%F %H:%M')"
    {
      echo
      echo "## ðŸ“… $DATE"
      echo
      echo "- Mode: commit"
      echo "- Risk: $RISK"
      echo "- Changes:"
      git diff --name-only HEAD
    } >>"$SESSION_FILE"

    ok "SESJA.md updated"
  fi
fi

# ---------- FINAL SAFETY ----------
read -r -p "KontynuowaÄ‡? (wpisz 'zamykamy' aby przerwaÄ‡): " LAST
if [[ "$LAST" == "zamykamy" ]]; then
  fail "Przerwano hasÅ‚em awaryjnym"
fi

ok "NSS completed successfully"
